---
import RenderedMarkdown from "@/components/astro/rendered-markdown.astro";
import Typography from "@/components/astro/typography.astro";
import { ButtonLink } from "@/components/ui/button-link";
import { ScriptImageActionButtons } from "@/components/react/script-image-action-buttons";
import { ScriptImageTabs } from "@/components/react/script-image-tabs";
import Layout from "@/layouts/Layout.astro";
import { parseScriptData } from "@/utils/script";
import { render, getEntry, getCollection } from "astro:content";
import { ArrowLeftIcon } from "lucide-react";

export async function getStaticPaths() {
  const scripts = await getCollection("scripts");

  return Promise.all(
    scripts.map(async (script) => {
      const [base] = script.id.split("/");

      // TODO: likely a much better way to do this?
      const [changelog, readme] = await Promise.all([
        getEntry("scriptChangelogs", `${base}/changelog`),
        getEntry("scriptReadmes", `${base}/readme`),
      ]);

      return {
        params: { slug: script.id },
        props: { script: parseScriptData(script), changelog, readme },
      };
    }),
  );
}

const { script, changelog, readme } = Astro.props;

const ChangelogContent = changelog ? (await render(changelog)).Content : null;
const ReadmeContent = readme ? (await render(readme)).Content : null;
---

<Layout containerClass="space-y-4">
  <div>
    <ButtonLink variant="link" href="/scripts">
      <ArrowLeftIcon className="size-4" />
      Back to Scripts
    </ButtonLink>
  </div>
  <div class="grid grid-cols-12 gap-4">
    <div class="col-span-8">
      <div class="max-h-[700px] overflow-auto rounded-md border">
        {
          ReadmeContent ? (
            <RenderedMarkdown>
              <ReadmeContent />
            </RenderedMarkdown>
          ) : (
            <Typography class="text-center">TODO: handle empty state for readme</Typography>
          )
        }
      </div>
    </div>
    <div class="col-span-4 rounded-md border">
      {
        readme?.data.frontImage && readme?.data.backImage && (
          <div>
            <ScriptImageTabs
              client:load
              frontImage={{
                src: readme.data.frontImage.src,
                height: readme.data.frontImage.height,
                width: readme.data.frontImage.width,
              }}
              backImage={{
                src: readme.data.backImage.src,
                height: readme.data.backImage.height,
                width: readme.data.backImage.width,
              }}
            />
          </div>
        )
      }
      <div class="my-4 flex justify-center">
        <ScriptImageActionButtons
          client:load
          script={script}
          frontImageSrc={readme?.data.frontImage?.src}
          backImageSrc={readme?.data.backImage?.src}
        />
      </div>
    </div>
  </div>
  <div class="grid grid-cols-12 gap-4">
    <div class="col-span-8">
      <div class="max-h-[700px] overflow-auto rounded-md border">
        {
          ChangelogContent ? (
            <RenderedMarkdown>
              <ChangelogContent />
            </RenderedMarkdown>
          ) : (
            <Typography class="text-center">TODO: handle empty state for changelog</Typography>
          )
        }
      </div>
    </div>
    <div class="col-span-4 rounded-md border">
      <div>
        <Typography class="text-center">TODO: History</Typography>
      </div>
    </div>
  </div>
</Layout>
